<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smartâ€‘ATM | Register Face</title>
<style>
 body{background:#1a1a1a;font-family:"Segoe UI",sans-serif;
      color:#00ffcc;text-align:center;padding:30px}
 form,video,canvas,button{margin:20px auto;display:block}
 input,button{width:280px;padding:10px;font-size:16px;border:none;border-radius:6px}
 button{background:#00ffcc;color:#1a1a1a;font-weight:bold;cursor:pointer;transition:.3s}
 button:hover{background:#00bfa6}
 button:disabled{background:#555;cursor:not-allowed}
 #video,#canvas{max-width:300px;width:100%;border-radius:10px}
 #message{margin-top:15px;min-height:22px;font-weight:bold}
 #capturedPreview{margin-top:10px;max-width:300px;border:2px solid #00ffcc;border-radius:10px;display:none}
</style>
</head>
<body>
 <h1>ðŸ§  RegisterÂ YourÂ Face</h1>

 <div id="verify-section">
   <form id="authForm">
     <input type="text"     id="phone" placeholder="Enter phone" required autocomplete="off"/>
     <input type="password" id="pin"   placeholder="Enter 4â€‘digit PIN" required maxlength="4" autocomplete="off"/>
     <button type="submit"  id="verifyBtn">Verify & Start Camera</button>
   </form>
 </div>

 <video  id="video"  autoplay playsinline style="display:none;"></video>
 <canvas id="canvas" style="display:none;"></canvas>
 <button id="captureBtn" style="display:none;">ðŸ“¸Â CaptureÂ &Â Register</button>

 <img id="capturedPreview" alt="Captured face preview"/>

 <div id="message"></div>

<script>
const phoneInput   = document.getElementById('phone');
const pinInput     = document.getElementById('pin');
const verifyBtn    = document.getElementById('verifyBtn');
const video        = document.getElementById('video');
const canvas       = document.getElementById('canvas');
const captureBtn   = document.getElementById('captureBtn');
const msgDiv       = document.getElementById('message');
const previewImg   = document.getElementById('capturedPreview');
const verifySec    = document.getElementById('verify-section');
let stream = null;

function showMsg(m, err=false){
  msgDiv.textContent = m;
  msgDiv.style.color = err ? '#ff4444' : '#00ffcc';
}

document.getElementById('authForm').addEventListener('submit', async e=>{
  e.preventDefault();
  showMsg('');
  verifyBtn.disabled = true;

  try{
    const res  = await fetch('/verify-user',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phone: phoneInput.value.trim(), pin: pinInput.value.trim()})
    });
    const data = await res.json();
    if(data.success){
      verifySec.style.display='none';
      video.style.display     ='block';
      captureBtn.style.display='inline-block';
      stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      video.srcObject = stream;
      showMsg('Camera started.Â Capture your face.');
    }else{
      showMsg('Invalid phone or PIN', true);
    }
  }catch(err){showMsg('Error: '+err.message,true);}
  verifyBtn.disabled = false;
});

captureBtn.addEventListener('click', async ()=>{
  if(!stream){showMsg('Webcam not started',true);return;}

  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  const imgB64 = canvas.toDataURL('image/png');
  previewImg.src = imgB64; previewImg.style.display='block';
  showMsg('Uploadingâ€¦'); captureBtn.disabled=true;

  try{
    const res  = await fetch('/register-face',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phone: phoneInput.value.trim(), image: imgB64})
    });
    const data = await res.json();
    showMsg(data.message, !data.success);

    if(data.success){
      setTimeout(()=>{
        stream.getTracks().forEach(t=>t.stop());
        video.style.display='none'; captureBtn.style.display='none'; previewImg.style.display='none';
        verifySec.style.display='block'; phoneInput.value=''; pinInput.value='';
        showMsg('Registration complete.');
      },1800);
    }
  }catch(err){showMsg('Error registering: '+err.message,true);}
  captureBtn.disabled=false;
});
</script>
</body>
</html>
